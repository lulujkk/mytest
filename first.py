import streamlit as st
import pandas as pd
import numpy as np

# --------------------------
# é¡µé¢é…ç½®ï¼ˆè‡ªå®šä¹‰ç½‘å€ï¼šæ›¿æ¢ä¸ºå­¦ç”Ÿå§“åå…¨æ‹¼+3ï¼Œå¦‚luziguang3ï¼‰
# --------------------------
st.set_page_config(
    page_title="å—å®KTVæ•°æ®ä»ªè¡¨ç›˜",
    page_icon="ğŸ¤",
    layout="wide",
    initial_sidebar_state="expanded"
)

# è‡ªå®šä¹‰CSSï¼ˆä¼˜åŒ–å›¾è¡¨æ ·å¼ã€æ–‡å­—æ’ç‰ˆï¼‰
st.markdown("""
<style>
    /* å…¨å±€å­—ä½“ */
    body {font-family: "Microsoft YaHei", sans-serif;}
    /* æŒ‡æ ‡å¡æ ·å¼ */
    .stMetric {background-color: #f0f8fb; border-radius: 8px; padding: 10px;}
    /* å›¾è¡¨æ ‡é¢˜æ ·å¼ */
    h3 {color: #006688;}
    /* æ•°æ®æ¡†æ ·å¼ */
    .stDataFrame {border: 1px solid #e6f7ff; border-radius: 8px;}
</style>
""", unsafe_allow_html=True)

# --------------------------
# 1. æ•°æ®å‡†å¤‡ï¼ˆå—å®KTVç›¸å…³æ•°æ®ï¼Œ6å®¶åº—é“ºæ»¡è¶³5+è¦æ±‚ï¼‰
# --------------------------
# ï¼ˆ1ï¼‰KTVåº—é“ºåŸºç¡€ä¿¡æ¯ï¼ˆåŒ…å«é‡è´©å¼/å•†åŠ¡å¼ç­‰ç±»å‹ï¼Œç»çº¬åº¦ä¸ºå—å®çœŸå®åŒºåŸŸåæ ‡ï¼‰
ktv_shops_data = {
    "åº—é“ºåç§°": [
        "çº¯K(å—å®ä¸‡è±¡åŸåº—)",
        "æ˜Ÿèšä¼šKTV(å—å®èˆªæ´‹åŸåº—)",
        "ä½°è¿ªä¹KTV(å—å®æœé˜³åº—)",
        "å¤§æ­Œæ˜ŸKTV(å—å®ä¸‡è¾¾åº—)",
        "éº¦éœ¸KTV(å—å®è¥¿ä¹¡å¡˜åº—)",
        "ç››ä¸–å˜‰å¹´åKTV(å—å®æ±Ÿå—åº—)"
    ],
    "KTVç±»å‹": ["é‡è´©å¼", "é‡è´©å¼", "é‡è´©å¼", "é‡è´©å¼", "å•†åŠ¡å¼", "å•†åŠ¡å¼"],
    "è¯„åˆ†": [4.9, 4.8, 4.7, 4.6, 4.5, 4.4],
    "åœ°å€": [
        "å—å®å¸‚é’ç§€åŒºæ°‘æ—å¤§é“136å·ä¸‡è±¡åŸ",
        "å—å®å¸‚é’ç§€åŒºæ°‘æ—å¤§é“131å·èˆªæ´‹åŸ",
        "å—å®å¸‚å…´å®åŒºæœé˜³è·¯38å·å—å®ç™¾è´§å¤§æ¥¼",
        "å—å®å¸‚é’ç§€åŒºä¸‡è¾¾å¹¿åœº1å·é—¨4æ¥¼",
        "å—å®å¸‚è¥¿ä¹¡å¡˜åŒºå¤§å­¦ä¸œè·¯98å·ä¸–è´¸è¥¿åŸ",
        "å—å®å¸‚æ±Ÿå—åŒºæ˜Ÿå…‰å¤§é“46å·å—å®æ±Ÿå—ä¸‡è¾¾å¹¿åœº"
    ],
    "çº¬åº¦": [22.8175, 22.8268, 22.8200, 22.8140, 22.8465, 22.7880],
    "ç»åº¦": [108.3460, 108.3520, 108.3220, 108.3420, 108.3050, 108.3480],
    "å°åŒ…å¢å°æ—¶æ¶ˆè´¹(å…ƒ)": [88, 78, 68, 75, 128, 118],
    "æœˆå‡é¢„è®¢é‡(æ¬¡)": [1200, 1050, 1100, 950, 800, 750]
}
df_shops = pd.DataFrame(ktv_shops_data)

# ï¼ˆ2ï¼‰12ä¸ªæœˆå°åŒ…å¢ä»·æ ¼èµ°åŠ¿æ•°æ®ï¼ˆ6å®¶KTVï¼Œæ»¡è¶³5+æŠ˜çº¿è¦æ±‚ï¼Œä»·æ ¼éšèŠ‚å‡æ—¥å¾®è°ƒï¼‰
months = ["1æœˆ", "2æœˆ", "3æœˆ", "4æœˆ", "5æœˆ", "6æœˆ", "7æœˆ", "8æœˆ", "9æœˆ", "10æœˆ", "11æœˆ", "12æœˆ"]
price_trend_data = {
    "æœˆä»½": months,
    "çº¯K(å—å®ä¸‡è±¡åŸåº—)": [88, 98, 88, 88, 98, 88, 88, 98, 88, 98, 88, 98],  # èŠ‚å‡æ—¥æ¶¨ä»·
    "æ˜Ÿèšä¼šKTV(å—å®èˆªæ´‹åŸåº—)": [78, 88, 78, 78, 88, 78, 78, 88, 78, 88, 78, 88],
    "ä½°è¿ªä¹KTV(å—å®æœé˜³åº—)": [68, 78, 68, 68, 78, 68, 68, 78, 68, 78, 68, 78],
    "å¤§æ­Œæ˜ŸKTV(å—å®ä¸‡è¾¾åº—)": [75, 85, 75, 75, 85, 75, 75, 85, 75, 85, 75, 85],
    "éº¦éœ¸KTV(å—å®è¥¿ä¹¡å¡˜åº—)": [128, 138, 128, 128, 138, 128, 128, 138, 128, 138, 128, 138],
    "ç››ä¸–å˜‰å¹´åKTV(å—å®æ±Ÿå—åº—)": [118, 128, 118, 118, 128, 118, 118, 128, 118, 128, 118, 128]
}
df_price_trend = pd.DataFrame(price_trend_data)

# ï¼ˆ3ï¼‰KTVç±»å‹æœˆåº¦é¢„è®¢é‡æ•°æ®ï¼ˆä¼˜åŒ–ï¼šå¢åŠ ç»†åˆ†ç±»å‹ï¼ŒæŒ‰é¢„è®¢é‡é™åºæ’åˆ—ï¼‰
category_booking = {
    "KTVç±»å‹": ["é‡è´©å¼ï¼ˆé«˜ç«¯ï¼‰", "é‡è´©å¼ï¼ˆä¸­ç«¯ï¼‰", "é‡è´©å¼ï¼ˆå¹³ä»·ï¼‰", "å•†åŠ¡å¼ï¼ˆé«˜ç«¯ï¼‰", "å•†åŠ¡å¼ï¼ˆä¸­ç«¯ï¼‰"],
    "æœˆé¢„è®¢é‡(æ¬¡)": [12000, 9500, 7800, 6500, 4200]
}
df_category_booking = pd.DataFrame(category_booking).sort_values(by="æœˆé¢„è®¢é‡(æ¬¡)", ascending=False)  # é™åºæ’åˆ—

# ï¼ˆ4ï¼‰ç”¨æˆ·è¯„ä»·åˆ†å¸ƒæ•°æ®ï¼ˆä¼˜åŒ–ï¼šå †å é¢ç§¯å›¾ï¼ŒåŒ…å«å¥½è¯„/ä¸­è¯„/å·®è¯„ï¼Œæ•°æ®æ›´è´´åˆå®é™…ï¼‰
review_data = {
    "æœˆä»½": months,
    "å¥½è¯„æ•°": [950, 1020, 980, 920, 1050, 1100, 1150, 1200, 1100, 1050, 980, 1020],
    "ä¸­è¯„æ•°": [80, 70, 85, 90, 75, 70, 65, 70, 75, 80, 85, 80],
    "å·®è¯„æ•°": [20, 15, 25, 30, 18, 15, 12, 15, 18, 20, 25, 20]
}
df_review = pd.DataFrame(review_data)

# ï¼ˆ5ï¼‰å…³é”®æŒ‡æ ‡è®¡ç®—ï¼ˆç”¨äºæŒ‡æ ‡å¡å±•ç¤ºï¼‰
max_rating = df_shops["è¯„åˆ†"].max()
avg_consumption = round(df_shops["å°åŒ…å¢å°æ—¶æ¶ˆè´¹(å…ƒ)"].mean(), 1)
total_bookings = df_shops["æœˆå‡é¢„è®¢é‡(æ¬¡)"].sum()

# --------------------------
# 2. ä¾§è¾¹æ ç­›é€‰ï¼ˆä¼˜åŒ–ï¼šå¢åŠ è¯„åˆ†åŒºé—´ã€æ¶ˆè´¹åŒºé—´ç­›é€‰ï¼‰
# --------------------------
st.sidebar.header("ğŸ›ï¸ ç­›é€‰æ¡ä»¶")

# KTVç±»å‹ç­›é€‰
selected_type = st.sidebar.multiselect(
    "é€‰æ‹©KTVç±»å‹",
    options=df_shops["KTVç±»å‹"].unique(),
    default=df_shops["KTVç±»å‹"].unique()
)

# è¯„åˆ†åŒºé—´ç­›é€‰
rating_range = st.sidebar.slider(
    "é€‰æ‹©è¯„åˆ†åŒºé—´",
    min_value=4.0,
    max_value=5.0,
    value=(4.0, 5.0),
    step=0.1
)

# æ¶ˆè´¹åŒºé—´ç­›é€‰
price_range = st.sidebar.slider(
    "é€‰æ‹©å°åŒ…å¢å°æ—¶æ¶ˆè´¹åŒºé—´(å…ƒ)",
    min_value=int(df_shops["å°åŒ…å¢å°æ—¶æ¶ˆè´¹(å…ƒ)"].min()),
    max_value=int(df_shops["å°åŒ…å¢å°æ—¶æ¶ˆè´¹(å…ƒ)"].max()),
    value=(int(df_shops["å°åŒ…å¢å°æ—¶æ¶ˆè´¹(å…ƒ)"].min()), int(df_shops["å°åŒ…å¢å°æ—¶æ¶ˆè´¹(å…ƒ)"].max())),
    step=5
)

# å¤šæ¡ä»¶ç­›é€‰æ•°æ®
df_shops_filtered = df_shops[
    (df_shops["KTVç±»å‹"].isin(selected_type)) &
    (df_shops["è¯„åˆ†"] >= rating_range[0]) &
    (df_shops["è¯„åˆ†"] <= rating_range[1]) &
    (df_shops["å°åŒ…å¢å°æ—¶æ¶ˆè´¹(å…ƒ)"] >= price_range[0]) &
    (df_shops["å°åŒ…å¢å°æ—¶æ¶ˆè´¹(å…ƒ)"] <= price_range[1])
]

# --------------------------
# 3. ä¸»é¡µé¢å†…å®¹å¸ƒå±€ï¼ˆä¼˜åŒ–ï¼šæ–°å¢æŒ‡æ ‡å¡ï¼Œåˆ†å—æ›´æ¸…æ™°ï¼‰
# --------------------------
st.title("ğŸ¤ å—å®KTVæ•°æ®ä»ªè¡¨ç›˜")
st.markdown("---")

# ç¬¬ä¸€è¡Œï¼šå…³é”®æŒ‡æ ‡å¡ï¼ˆæ–°å¢ï¼Œæå‡æ•°æ®æ¦‚è§ˆæ€§ï¼‰
col1, col2, col3 = st.columns(3)
with col1:
    st.metric(label="ğŸ† æœ€é«˜åº—é“ºè¯„åˆ†", value=max_rating, delta=f"{max_rating - df_shops['è¯„åˆ†'].min():.1f} åˆ†ï¼ˆé¢†å…ˆæœ€ä½åˆ†ï¼‰")
with col2:
    st.metric(label="ğŸ’° å¹³å‡å°æ—¶æ¶ˆè´¹", value=f"{avg_consumption} å…ƒ", delta=f"{avg_consumption - df_shops['å°åŒ…å¢å°æ—¶æ¶ˆè´¹(å…ƒ)'].min():.1f} å…ƒï¼ˆé«˜äºæœ€ä½æ¶ˆè´¹ï¼‰")
with col3:
    st.metric(label="ğŸ“… æ€»æœˆé¢„è®¢é‡", value=f"{total_bookings} æ¬¡", delta=f"{total_bookings - df_shops['æœˆå‡é¢„è®¢é‡(æ¬¡)'].min()} æ¬¡ï¼ˆé«˜äºæœ€ä½é¢„è®¢é‡ï¼‰")

st.markdown("---")

# ç¬¬äºŒè¡Œï¼šåº—é“ºä¿¡æ¯å±•ç¤º + 12ä¸ªæœˆä»·æ ¼èµ°åŠ¿æŠ˜çº¿å›¾ï¼ˆä¼˜åŒ–ï¼šæŠ˜çº¿å›¾é¢œè‰²ä¸»é¢˜ï¼Œäº¤äº’å¢å¼ºï¼‰
col1, col2 = st.columns([1, 2])

with col1:
    st.subheader("å—å®çƒ­é—¨KTVåº—é“ºä¿¡æ¯")
    st.dataframe(
        df_shops_filtered[["åº—é“ºåç§°", "KTVç±»å‹", "è¯„åˆ†", "åœ°å€", "å°åŒ…å¢å°æ—¶æ¶ˆè´¹(å…ƒ)", "æœˆå‡é¢„è®¢é‡(æ¬¡)"]],
        use_container_width=True,
        hide_index=True
    )

with col2:
    st.subheader("6å®¶KTVå°åŒ…å¢12ä¸ªæœˆä»·æ ¼èµ°åŠ¿")
    # åŸç”ŸStreamlitæŠ˜çº¿å›¾ï¼Œé…ç½®è‡ªå®šä¹‰é¢œè‰²å’Œäº¤äº’
    st.line_chart(
        df_price_trend,
        x="æœˆä»½",
        y=df_price_trend.columns[1:],  # æ‰€æœ‰KTVçš„ä»·æ ¼åˆ—
        use_container_width=True,
        color=["#006688", "#0099cc", "#33cccc", "#66b3ff", "#9966cc", "#cc6699"],  # é’ç»¿è‰²ç³»æ¸å˜
        width=0,
        height=400
    )

st.markdown("---")

# ç¬¬ä¸‰è¡Œï¼šKTVç±»å‹é¢„è®¢é‡æŸ±çŠ¶å›¾ï¼ˆä¼˜åŒ–ï¼šé™åºæ’åˆ—ã€æ¸å˜é¢œè‰²ï¼‰ + ç”¨æˆ·è¯„ä»·å †å é¢ç§¯å›¾ï¼ˆä¼˜åŒ–ï¼šå †å æ¨¡å¼ï¼‰
col3, col4 = st.columns(2)

with col3:
    st.subheader("KTVç±»å‹æœˆåº¦é¢„è®¢é‡åˆ†å¸ƒ")
    # åŸç”ŸStreamlitæŸ±çŠ¶å›¾ï¼Œä½¿ç”¨ä¸»è‰²è°ƒå¢å¼ºè§†è§‰ç»Ÿä¸€æ€§
    st.bar_chart(
        df_category_booking,
        x="KTVç±»å‹",
        y="æœˆé¢„è®¢é‡(æ¬¡)",
        use_container_width=True,
        color="#006688",  # ä¸»è‰²è°ƒ
        width=0,
        height=400
    )

with col4:
    st.subheader("ç”¨æˆ·è¯„ä»·åˆ†å¸ƒï¼ˆæŒ‰æœˆä»½ï¼‰")
    # åŸç”ŸStreamlité¢ç§¯å›¾ï¼Œå †å æ¨¡å¼+è‡ªå®šä¹‰é¢œè‰²
    st.area_chart(
        df_review,
        x="æœˆä»½",
        y=["å¥½è¯„æ•°", "ä¸­è¯„æ•°", "å·®è¯„æ•°"],
        use_container_width=True,
        color=["#009966", "#ffcc00", "#ff6666"],  # å¥½è¯„ç»¿ã€ä¸­è¯„é»„ã€å·®è¯„çº¢
        stack=True,  # å †å æ¨¡å¼
        width=0,
        height=400
    )

st.markdown("---")

# ç¬¬å››è¡Œï¼šKTVåº—é“ºä½ç½®åœ°å›¾ï¼ˆä¼˜åŒ–ï¼šæ ‡è®°å¤§å°éšè¯„åˆ†å˜åŒ–ï¼‰
st.subheader("å—å®KTVåº—é“ºä½ç½®åˆ†å¸ƒ")
# åŸç”ŸStreamlit mapï¼šæ ‡è®°å¤§å°éšè¯„åˆ†å˜åŒ–ï¼Œä½¿ç”¨ä¸»è‰²è°ƒ
st.map(
    df_shops_filtered,
    latitude="çº¬åº¦",
    longitude="ç»åº¦",
    size=df_shops_filtered["è¯„åˆ†"] * 100,  # æ ‡è®°å¤§å°éšè¯„åˆ†å˜åŒ–
    color="#006688"  # ä¸»è‰²è°ƒ
)

# --------------------------
# 4. é¡µè„šä¿¡æ¯
# --------------------------
st.markdown("---")
st.markdown("### ğŸ“ æ•°æ®è¯´æ˜ï¼šæœ¬ä»ªè¡¨ç›˜æ•°æ®ä¸ºå—å®KTVè¡Œä¸šæ¨¡æ‹Ÿæ•°æ®ï¼Œä»…ä¾›å±•ç¤ºä½¿ç”¨ã€‚")
