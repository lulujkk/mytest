import streamlit as st
import pandas as pd
import numpy as np
import json  # ç¡®ä¿JSONåºåˆ—åŒ–æ­£å¸¸

# --------------------------
# å·¥å…·å‡½æ•°ï¼šå°†NumPyç±»å‹è½¬æ¢ä¸ºPythonåŸç”Ÿç±»å‹ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šè§£å†³JSONåºåˆ—åŒ–é—®é¢˜ï¼‰
# --------------------------
def convert_numpy_to_python(df):
    """éå†æ•°æ®æ¡†ï¼Œå°†NumPyæ•°å€¼ç±»å‹è½¬ä¸ºPythonåŸç”Ÿç±»å‹"""
    for col in df.columns:
        if df[col].dtype in [np.int64, np.int32, np.int16]:
            df[col] = df[col].astype(int)  # è½¬ä¸ºPython int
        elif df[col].dtype in [np.float64, np.float32, np.float16]:
            df[col] = df[col].astype(float)  # è½¬ä¸ºPython float
    return df

# --------------------------
# é¡µé¢é…ç½® + æ·±è‰²ä¸»é¢˜è‡ªå®šä¹‰æ ·å¼
# --------------------------
st.set_page_config(
    page_title="å—å®ç¾é£Ÿæ•°æ®ä»ªè¡¨ç›˜",
    page_icon="ğŸœ",
    layout="wide",
    initial_sidebar_state="collapsed"  # éšè—ä¾§è¾¹æ ï¼Œè´´åˆç¤ºä¾‹ç•Œé¢
)

# è‡ªå®šä¹‰æ·±è‰²ä¸»é¢˜CSSï¼ˆåŒ¹é…ç¤ºä¾‹çš„æ·±è‰²èƒŒæ™¯+æµ…è‰²å†…å®¹ï¼‰
st.markdown("""
<style>
    /* å…¨å±€æ·±è‰²èƒŒæ™¯ + æµ…è‰²æ–‡å­— */
    .stApp {
        background-color: #121212;
        color: #ffffff;
    }
    /* æ ‡é¢˜/å­æ ‡é¢˜é¢œè‰² */
    h2, h3, h4 {
        color: #f0f0f0;
        font-weight: 600;
    }
    /* å›¾è¡¨èƒŒæ™¯é€æ˜ */
    .st-chart {
        background-color: transparent !important;
    }
    /* æ•°æ®æ¨¡å—èƒŒæ™¯ */
    .stMetric {
        background-color: #1E1E1E;
        color: #ffffff;
        border-radius: 8px;
        padding: 10px;
    }
    /* åˆ†å‰²çº¿æ ·å¼ */
    hr {
        border-top: 1px solid #333333;
    }
    /* ä¿®å¤Xè½´æ ‡ç­¾æ¨ªå‘æ˜¾ç¤º */
    .st-chart svg g[class*="xtick"] text {
        writing-mode: horizontal-tb !important;
        transform: rotate(0deg) !important;
        text-anchor: middle !important;
        font-size: 14px !important;
    }
    .st-chart svg {
        padding-bottom: 20px !important;
    }
</style>
""", unsafe_allow_html=True)

# --------------------------
# 1. æ•°æ®å‡†å¤‡ï¼ˆè‡³å°‘5å®¶å—å®ç¾é£Ÿåº— + å¯¹åº”å›¾è¡¨æ•°æ®ï¼Œä¿®å¤æ•°æ®ç±»å‹ï¼‰
# --------------------------
# ï¼ˆ1ï¼‰å—å®ç¾é£Ÿåº—é“ºåŸºç¡€ä¿¡æ¯ï¼ˆ6å®¶ï¼Œå«åæ ‡/è¯„åˆ†/åœ°å€ï¼‰
shops_data = {
    "åº—é“ºåç§°": [
        "ä¸­å±±è·¯è€å‹ç²‰æ€»åº—",
        "å¤è®°è€å‹ç²‰ä¸ƒæ˜Ÿè·¯åº—",
        "å—é“èºè›³ç²‰æ€»åº—",
        "é‚•å·è€è¡—ç²‰é¥ºç‹",
        "ç”˜å®¶ç•ŒæŸ æª¬é¸­æ€»åº—",
        "å·ç­’ç²‰æ˜å›­åº—"  # é¢å¤–å¢åŠ 1å®¶ï¼Œç¡®ä¿â‰¥5å®¶
    ],
    "è¯„åˆ†": [4.8, 4.7, 4.6, 4.5, 4.9, 4.7],
    "åœ°å€": [
        "å—å®å¸‚é’ç§€åŒºä¸­å±±è·¯66å·",
        "å—å®å¸‚é’ç§€åŒºä¸ƒæ˜Ÿè·¯89å·",
        "å—å®å¸‚è¥¿ä¹¡å¡˜åŒºå—é“ä¸€è¡—23å·",
        "å—å®å¸‚æ±Ÿå—åŒºé‚•å·è€è¡—12å·",
        "å—å®å¸‚å…´å®åŒºé‚•æ­¦è·¯18å·",
        "å—å®å¸‚é’ç§€åŒºæ°‘ä¸»è·¯12å·"
    ],
    "çº¬åº¦": [22.8167, 22.8215, 22.8450, 22.7890, 22.8670, 22.8250],
    "ç»åº¦": [108.3220, 108.3280, 108.3020, 108.3450, 108.3350, 108.3300],
    "æ‹›ç‰Œèœä»·æ ¼(å…ƒ)": [18, 16, 15, 12, 68, 10]
}
df_shops = pd.DataFrame(shops_data)
# æ ¸å¿ƒä¿®å¤ï¼šè½¬æ¢ä¸ºPythonåŸç”Ÿç±»å‹ï¼Œè§£å†³JSONåºåˆ—åŒ–é—®é¢˜
df_shops = convert_numpy_to_python(df_shops)

# ï¼ˆ2ï¼‰5å®¶é¤å…12ä¸ªæœˆä»·æ ¼èµ°åŠ¿ï¼ˆæ»¡è¶³â€œ5æ¡æŠ˜çº¿â€è¦æ±‚ï¼‰
months = ["1æœˆ", "2æœˆ", "3æœˆ", "4æœˆ", "5æœˆ", "6æœˆ", "7æœˆ", "8æœˆ", "9æœˆ", "10æœˆ", "11æœˆ", "12æœˆ"]
price_trend_data = {
    "æœˆä»½": months,
    "ä¸­å±±è·¯è€å‹ç²‰": [18, 18, 19, 19, 20, 20, 20, 19, 19, 18, 18, 18],
    "å¤è®°è€å‹ç²‰": [16, 16, 15, 15, 16, 16, 16, 15, 15, 16, 16, 15],
    "å—é“èºè›³ç²‰": [15, 15, 14, 14, 15, 15, 15, 14, 14, 15, 15, 14],
    "é‚•å·è€è¡—ç²‰é¥ºç‹": [12, 12, 12, 11, 11, 12, 12, 11, 11, 12, 12, 12],
    "ç”˜å®¶ç•ŒæŸ æª¬é¸­": [68, 68, 70, 70, 72, 72, 72, 70, 70, 68, 68, 68]
}
df_price_trend = pd.DataFrame(price_trend_data)
df_price_trend = convert_numpy_to_python(df_price_trend)

# ï¼ˆ3ï¼‰ç”¨é¤é«˜å³°æ—¶æ®µæ•°æ®ï¼ˆç”¨äºarea_chartï¼‰
meal_time_data = {
    "æ—¶æ®µ": ["10:00", "11:00", "12:00", "13:00", "14:00", "17:00", "18:00", "19:00", "20:00", "21:00"],
    "å®¢æµ": [50, 120, 200, 150, 80, 100, 220, 250, 180, 100]
}
df_meal_time = pd.DataFrame(meal_time_data)
df_meal_time = convert_numpy_to_python(df_meal_time)

# --------------------------
# 2. ç•Œé¢å¸ƒå±€ï¼ˆæ¨¡ä»¿ç¤ºä¾‹çš„å‚ç›´æ¨¡å—æ’åˆ—ï¼Œä¿®å¤st.mapå‚æ•°ï¼‰
# --------------------------
st.title("ğŸœ å—å®ç¾é£Ÿæ•°æ®ä»ªè¡¨ç›˜")
st.markdown("---")

# æ¨¡å—1ï¼šé¤å…åˆ†å¸ƒåœ°å›¾ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šsizeå‚æ•°è½¬ä¸ºæ•´æ•° + ç©ºæ•°æ®å¤„ç†ï¼‰
st.subheader("ğŸ“ é¤å…åˆ†å¸ƒ")
if len(df_shops) == 0:
    st.warning("âš ï¸ æš‚æ— é¤å…æ•°æ®ï¼Œæ— æ³•æ˜¾ç¤ºåœ°å›¾ï¼")
else:
    # ä¿®å¤ï¼šsizeå‚æ•°è½¬ä¸ºæ•´æ•°ï¼ˆé¿å…æµ®ç‚¹æ•°åºåˆ—åŒ–é—®é¢˜ï¼‰
    map_size = (df_shops["è¯„åˆ†"] * 150).astype(int)  # è½¬ä¸ºæ•´æ•°
    st.map(
        df_shops,
        latitude="çº¬åº¦",
        longitude="ç»åº¦",
        size=map_size,  # æ•´æ•°ç±»å‹
        color="#2196F3",
        zoom=11
    )
st.markdown("---")

# æ¨¡å—2ï¼šé¤å…è¯„åˆ†æŸ±çŠ¶å›¾
st.subheader("â­ é¤å…è¯„åˆ†")
st.bar_chart(
    df_shops,
    x="åº—é“ºåç§°",
    y="è¯„åˆ†",
    color="#4CAF50",  # é€‚é…æ·±è‰²çš„ç»¿è‰²
    height=350,
    use_container_width=True
)
st.markdown("---")

# æ¨¡å—3ï¼š5å®¶é¤å…12ä¸ªæœˆä»·æ ¼èµ°åŠ¿æŠ˜çº¿å›¾ï¼ˆæ»¡è¶³5æ¡æŠ˜çº¿è¦æ±‚ï¼‰
st.subheader("ğŸ“ˆ 5å®¶é¤å…12ä¸ªæœˆä»·æ ¼èµ°åŠ¿ï¼ˆå…ƒï¼‰")
# è°ƒæ•´åˆ—å®½ï¼Œè®©Xè½´æœˆä»½æ¨ªå‘æ˜¾ç¤ºæ›´èˆ’å±•
col_chart = st.columns(1)[0]
with col_chart:
    st.line_chart(
        df_price_trend,
        x="æœˆä»½",
        y=df_price_trend.columns[1:],  # 5å®¶é¤å…çš„ä»·æ ¼åˆ—ï¼ˆ5æ¡æŠ˜çº¿ï¼‰
        color=["#2196F3", "#FF9800", "#4CAF50", "#F44336", "#9C27B0"],  # å¤šè‰²åŒºåˆ†æŠ˜çº¿
        height=350,
        use_container_width=True
    )
st.markdown("---")

# æ¨¡å—4ï¼šç”¨é¤é«˜å³°æ—¶æ®µé¢ç§¯å›¾
st.subheader("â° ç”¨é¤é«˜å³°æ—¶æ®µå®¢æµåˆ†å¸ƒ")
st.area_chart(
    df_meal_time,
    x="æ—¶æ®µ",
    y="å®¢æµ",
    color="#2196F3",  # åŠé€æ˜è“è‰²é€‚é…æ·±è‰²
    height=350,
    use_container_width=True
)
st.markdown("---")

# æ¨¡å—5ï¼šé¤å…è¯„ä»·æ¦‚è§ˆ
st.subheader("ğŸ’¬ é¤å…è¯„ä»·æ¦‚è§ˆ")
col1, col2, col3 = st.columns(3)
with col1:
    max_rating_idx = df_shops["è¯„åˆ†"].idxmax()
    st.metric("æœ€é«˜è¯„åˆ†", f"{df_shops['è¯„åˆ†'].max()}åˆ†", df_shops["åº—é“ºåç§°"][max_rating_idx])
with col2:
    avg_price = df_shops["æ‹›ç‰Œèœä»·æ ¼(å…ƒ)"].mean()
    st.metric("å¹³å‡æ‹›ç‰Œèœä»·æ ¼", f"Â¥{avg_price:.1f}")
with col3:
    st.metric("æ”¶å½•åº—é“ºæ•°", f"{len(df_shops)}å®¶")
st.markdown("---")

# æ¨¡å—6ï¼šä»Šæ—¥ç¾é£Ÿæ¨èï¼ˆæ›¿æ¢ä¸ºæœ¬åœ°å›¾ç‰‡é“¾æ¥ï¼Œé¿å…å¤±æ•ˆï¼‰
st.subheader("ğŸ¥¢ ä»Šæ—¥æ¨èï¼šä¸­å±±è·¯è€å‹ç²‰")
st.markdown("**å—å®ç‰¹è‰²ï¼šè€å‹ç²‰ä»¥é…¸ã€è¾£ã€å’¸ã€é¦™è‘—ç§°ï¼Œæ˜¯å—å®äººçš„æ—©é¤é¦–é€‰ï¼**")
# ä½¿ç”¨ç½‘ç»œä¸Šçš„å—å®è€å‹ç²‰å›¾ç‰‡ï¼ˆç¨³å®šé“¾æ¥ï¼‰
st.image(
    "https://pic1.zhimg.com/80/v2-799c897990686609996688696877659c_1440w.jpg",
    caption="ä¸­å±±è·¯è€å‹ç²‰æ€»åº— - æ‹›ç‰Œè€å‹ç²‰",
    use_column_width=True
)
